# LLM Context - Begilda Gallery

## LLM Behavior
- Be direct and challenging — point out issues, don't sugarcoat
- When uncertain (< 98% sure), ask for clarification before proceeding
- Prioritize: security > type safety > maintainability > UX
- Explain architectural decisions and ask for permission on significant changes
- Use Context7 MCP for up-to-date documentation when available

---

## Quick Facts
- **Project**: Hybrid art gallery (physical in Kazakhstan + online platform)
- **Build**: Single-entry Vite (unified public + admin routing)
- **Frontend**: React 18 + TypeScript + Tailwind v4 + Radix UI + React Router v7
- **Backend**: Node.js + Express.js + TypeScript (src/server.ts with repository pattern)
- **Database**: Prisma ORM with SQLite (dev) / PostgreSQL (prod) - seamless switching via DATABASE_URL
- **Legacy**: JSON files in backend/data/ (deprecated), old server.js (760 lines, deprecated), better-sqlite3 implementation (replaced by Prisma)
- **Languages**: Russian, Kazakh, English (i18n planned, not implemented)
- **Currencies**: KZT (base), USD, EUR (frontend conversion)

---

## Critical Paths
| Purpose | Path |
|---------|------|
| **All routing** | [src/routes.tsx](../src/routes.tsx) (React Router v7, public + admin) |
| **Entry point** | [src/main.tsx](../src/main.tsx) (unified) |
| **HTML** | [index.html](../index.html) (single file) |
| **Admin app** | [src/app/AdminApp.tsx](../src/app/AdminApp.tsx) |
| **API client** | [src/api/client.ts](../src/api/client.ts) (300 lines, needs splitting) |
| **Backend server** | [backend/src/server.ts](../backend/src/server.ts) (514 lines, TypeScript) |
| **Backend repos** | [backend/src/repositories/](../backend/src/repositories/) (7 files, async Prisma queries) |
| **Database client** | [backend/src/db/client.ts](../backend/src/db/client.ts) (Prisma singleton) |
| **Prisma schema** | [backend/prisma/schema.prisma](../backend/prisma/schema.prisma) (10 models) |
| **Legacy schema** | [backend/src/db/schema.sql](../backend/src/db/schema.sql) (149 lines, reference only) |
| **Type models** | [src/types/models/](../src/types/models/) (9 files) |
| **Legacy data** | [backend/data/](../backend/data/) (JSON files, deprecated) |
| **Legacy server** | [backend/server.js](../backend/server.js) (760 lines, deprecated) |
| **Build config** | [vite.config.ts](../vite.config.ts) (@tailwindcss/vite plugin) |
| **Start script** | [start.sh](../start.sh) (launches backend + frontend) |

---

## Architecture Patterns

### Routing (Unified)
- **CURRENT**: React Router v7 with [routes.tsx](../src/routes.tsx) — handles both public and admin
- **Public routes**: Wrapped in [PublicLayout](../src/app/layouts/PublicLayout.tsx) component
- **Admin route**: Single route at `/${VITE_ADMIN_PATH_PREFIX}` → [AdminApp](../src/app/AdminApp.tsx)
- **LEGACY**: [src/app/App.tsx](../src/app/App.tsx) (348 lines, old custom routing — ignore completely)
- **Add Public Page**: Define route in routes.tsx under PublicLayout children, create page in src/app/pages/
- **Add Admin Feature**: Edit [AdminApp.tsx](../src/app/AdminApp.tsx) directly (uses internal state-based routing)

### Backend Architecture
- **Current**: TypeScript with repository pattern + Prisma ORM in [backend/src/](../backend/src/)
- **Server**: [src/server.ts](../backend/src/server.ts) with Express routes (all async)
- **Database**: Prisma Client with SQLite (dev) or PostgreSQL (prod)
- **Schema**: [prisma/schema.prisma](../backend/prisma/schema.prisma) with 10 models:
  - Artist, Painting, Exhibition, ExhibitionPainting (junction), News, ShopItem, PickupPoint, Order, OrderItem
  - Proper TypeScript types, DateTime fields, Boolean types, UUID primary keys
  - Indexes on frequently queried fields
- **Repositories**: Domain-specific async data access layer
  - [artists.ts](../backend/src/repositories/artists.ts)
  - [paintings.ts](../backend/src/repositories/paintings.ts)
  - [exhibitions.ts](../backend/src/repositories/exhibitions.ts)
  - [news.ts](../backend/src/repositories/news.ts)
  - [shop.ts](../backend/src/repositories/shop.ts)
  - [orders.ts](../backend/src/repositories/orders.ts)
  - [pickupPoints.ts](../backend/src/repositories/pickupPoints.ts)
- **Pattern**: Repository methods use Prisma Client (async), return typed data
- **Switching databases**: Change `DATABASE_URL` in .env and optionally update `provider` in schema.prisma
- **Legacy**: [backend/server.js](../backend/server.js) (760 lines, deprecated), old better-sqlite3 implementation

### API Layer
- **RULE**: Never fetch() directly in components — always use [src/api/client.ts](../src/api/client.ts)
- **CURRENT**: Monolithic (all resources in one file)
- **FUTURE**: Split into domain clients (paintings.ts, orders.ts, exhibitions.ts, etc.)
- **Pattern**: Helper functions (getHeaders, getJSON, postJSON, putJSON, deleteJSON) + resource functions
- **Example**: `import { getPaintings } from '@/api/client'; const paintings = await getPaintings();`

### State Management
- **App-level**: Context/props via [src/app/context/AppContext.tsx](../src/app/context/AppContext.tsx)
- **Persistence**: localStorage for cart, currency preference
- **No global library**: No Redux, Zustand, or Context API wrapper (use props or localStorage)
- **Pattern**: `const [data, setData] = useState<T[]>([]); const [loading, setLoading] = useState(true); const [error, setError] = useState<string | null>(null);`

### Build System
- **Vite config**: [vite.config.ts](../vite.config.ts) with single entry point (index.html)
- **Tailwind v4**: Uses `@tailwindcss/vite` plugin (NO tailwind.config.js needed)
- **Output**: dist/ with unified build (admin accessible via route, not separate bundle)
- **Dev server**: `npm run dev` (frontend) + `npm start` in backend/ (API server)
- **Production**: [start.sh](../start.sh) launches both backend and frontend

### File Upload
- **Backend**: Multer middleware, stores in [backend/uploads/](../backend/uploads/)
- **Limits**: 10MB max, JPEG/PNG/GIF/WebP only
- **Future**: Consider S3/Cloudinary for scalability

### Authentication
- **Status**: PARTIALLY IMPLEMENTED (bcrypt + JWT setup exists in backend)
- **Issue**: Admin endpoints still unprotected in production
- **Backend**: JWT signing/verification code present in [backend/src/server.ts](../backend/src/server.ts)
- **Frontend**: No auth UI or token management yet
- **Next Steps**: Build login page, protect admin routes, add Authorization headers to API calls

---

## TypeScript Standards
- **Strict mode**: No `any` types — define interfaces for everything
- **Interfaces**: Always for API payloads, component props, state objects
- **Use existing types**: See [src/types/models/](../src/types/models/) for 9 core models:
  - Painting, Exhibition, Artist, News, ShopItem, Order, PickupPoint, Cart, Artwork
- **File naming**:
  - Components: PascalCase.tsx (e.g., PaintingCard.tsx)
  - Utilities: camelCase.ts (e.g., formatCurrency.ts)
  - Types: PascalCase.ts in src/types/
  - Pages: PascalCase.tsx in src/app/pages/

### Code Style
- Use functional components + hooks
- Prefer `const` over `let`, never use `var`
- Early returns to avoid nesting (not ternaries or deep if-else)
- Keep components < 200 lines
- Extract reusable logic into custom hooks

---

## Known Issues & Gotchas

### Tailwind Configuration
- ❌ `tailwind.config.js` DOES NOT EXIST (referenced in old docs but removed)
- ✅ Project uses `@tailwindcss/vite` plugin in [vite.config.ts](../vite.config.ts)
- PostCSS config is empty (Tailwind v4 doesn't need it)

### Legacy Code to Ignore
- [src/app/App.tsx](../src/app/App.tsx) (348 lines) — Old router, completely deprecated
- [backend/server.js](../backend/server.js) (760 lines) — Old monolithic server, use [backend/src/server.ts](../backend/src/server.ts) instead
- [backend/data/*.json](../backend/data/) — JSON storage being phased out, SQLite is primary
- **_old files in admin**: ExhibitionsManager_old.tsx, NewsManager_old.tsx, ShopManager_old.tsx (safe to delete)
- [apps/](../apps/) and [packages/](../packages/) directories (unused monorepo structure, ignore)

### Code Quality Issues (Planned Improvements)
- [src/api/client.ts](../src/api/client.ts) (300 lines) uses `any` types (needs strict typing)
- [backend/server.js](../backend/server.js) (760 lines) still in use but deprecated — migrate fully to TypeScript version
- Admin app uses internal state-based routing instead of React Router v7 (consider migration)
- Authentication exists in backend but not enforced on admin endpoints (critical security gap)
- JSON files in backend/data/ should be removed once SQLite migration is verified complete

---

## Security Checklist

Before committing code:
- [ ] Input validation on both frontend and backend
- [ ] XSS sanitization before rendering user data
- [ ] File upload validation (type, size, virus scan if possible)
- [ ] Prisma handles parameterized queries automatically (SQL injection protection built-in)
- [ ] JWT validation on all admin endpoints (critical — currently missing)
- [ ] Never commit secrets to .env files
- [ ] Use HTTPS in production
- [ ] Run `npx prisma migrate dev` for schema changes in development
- [ ] Run `npx prisma migrate deploy` in production
- [ ] Backup database before migrations

---

## Component Inventory
- **Radix UI**: 48 pre-built components in [src/app/components/ui/](../src/app/components/ui/)
- **Custom**: ~16 components in [src/app/components/](../src/app/components/)
- **Pages**: 8 public (home, catalog, exhibitions, artists, shop, cart, checkout, news) + 4+ admin

---

## Environment Variables

**Backend (.env in backend/):**
```bash
# SQLite (development)
DATABASE_URL="file:./data/gallery.db"

# PostgreSQL (production)
# DATABASE_URL="postgresql://user:password@localhost:5432/begilda_gallery?schema=public"

JWT_SECRET="your-secret-key"
PORT=3001
```

**Frontend (.env):**
```bash
VITE_API_BASE_URL=http://localhost:3001/api
VITE_ADMIN_PATH_PREFIX=<your-secret-admin-prefix>
```

**Production (.env.production):**
```bash
VITE_API_BASE_URL=/api
VITE_ADMIN_PATH_PREFIX=<your-secret-admin-prefix>
```

---

## Git Conventions
Simple, descriptive commit messages:
```
Add painting detail page
Fix cart total calculation for multi-currency
Update exhibition filter to include past events
Remove unused admin components
```

- Start with a verb (Add, Fix, Update, Remove, Refactor)
- Keep first line < 72 characters
- Reference issue numbers when applicable: `Fix cart bug (#123)`

---

## Related Documentation
- [Roadmap](./improvements.md) — Feature priorities and planned improvements
- README.md — Setup instructions and overview

---

## Quick Start for New Contributors
1. Read this file (you're here)
2. Check [src/types/models/](../src/types/models/) for frontend data structures
3. Look at [src/routes.tsx](../src/routes.tsx) for routing patterns (unified public + admin)
4. Reference [src/api/client.ts](../src/api/client.ts) for API usage
5. Read [backend/src/server.ts](../backend/src/server.ts) to understand endpoints
6. Check [backend/src/repositories/](../backend/src/repositories/) for data access patterns (Prisma)
7. Review [backend/prisma/schema.prisma](../backend/prisma/schema.prisma) for database structure

## Prisma Commands
- `npx prisma generate` - Generate Prisma Client after schema changes
- `npx prisma db push` - Push schema to database (dev only, no migration history)
- `npx prisma migrate dev` - Create and apply migration (recommended)
- `npx prisma studio` - Open database GUI
- `npx prisma migrate deploy` - Apply migrations in production
